box:
  id: alpine
  cmd: /bin/sh

build:
  steps:
    - script:
        name: install dependencies
        code: |
          apk --update add openssh
          mv known_hosts /etc/ssh/ssh_known_hosts
          mkdir /root/.ssh/
          mv tunnel.conf /root/.ssh/config
          chmod 600 /root/.ssh/config

    - internal/docker-push:
        username: $QUAY_USER
        password: $QUAY_PASSWORD
        ports: "8080/tcp,8081/tcp"
        entrypoint: /usr/bin/ssh
        cmd: -nNTv home
        tag: $WERCKER_GIT_BRANCH-$WERCKER_GIT_COMMIT
        repository: cr.vertiv.life/cehoffman/home-tunnel
        registry: https://cr.vertiv.life/v2

deploy:
  box:
    id: cr.vertiv.life/cehoffman/k8s-deploy
    username: $QUAY_USER
    password: $QUAY_PASSWORD
    tag: latest
  steps:
    - bash-template

    - script:
        name: deploy
        code: |
          [ -z "$KUBE_CA_PEM_FILE" ] && export KUBE_CA_PEM_FILE=/tmp/ca.crt
          [ -n "$KUBE_CA_PEM" ] && echo "$KUBE_CA_PEM" > "$KUBE_CA_PEM_FILE"
          kubectl config set-cluster "$WERCKER_MAIN_PIPELINE_STARTED" --server="$KUBE_URL" --certificate-authority="$KUBE_CA_PEM_FILE" --embed-certs=true
          kubectl config set-credentials "$WERCKER_MAIN_PIPELINE_STARTED" --token="$KUBE_TOKEN"
          kubectl config set-context "$WERCKER_MAIN_PIPELINE_STARTED" --cluster="$WERCKER_MAIN_PIPELINE_STARTED" --user="$WERCKER_MAIN_PIPELINE_STARTED" --namespace="$KUBE_NAMESPACE"
          kubectl config use-context "$WERCKER_MAIN_PIPELINE_STARTED"
          ping -c 3 k8s.ceh.im
          k cluster-info
          k apply -f deployment.yml
